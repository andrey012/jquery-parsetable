/*
 *  jquery-parsetable - v0.1.2
 *  A jQuery plugin for capturing and parsing table data by copy-paste from text and spreadsheet editors directly to the form on web page.
 *  https://github.com/andrey012/jquery-parsetable.git
 *
 *  Made by Andrey Grinenko
 *  Under MIT License
 */
!function(a,b,c){"use strict";function d(b,c){this.element=b,this.settings=a.extend({},f,c),this._defaults=f,this._name=e,this.init()}var e="parseTable",f={pasteHeader:"Paste your table here",pasteLabel:"Paste table here (Ctrl-V)",pasteHint:"You can paste mixed data with several tables, just do Ctrl-A Ctrl-C Ctrl-V from your document",pasteError:"This contents does not look like a table",pasteOk:"Ok",pasteCancel:"Cancel",confirmHeaderSingle:"Confirm, that information is good",confirmHeaderMultiple:"Choose one of found tables",confirmLabelSingle:"Following information was found, check it and confirm:",confirmLabelMultiple:"Following information was found, choose correct one, check it and confirm:",confirmOk:"Use this information",confirmCancel:"Cancel",wait:"Please wait...",success:function(){alert("override me")},cancel:function(){},postProcess:function(a){return a},openOnPageLoad:!1,allowNewLines:!0};a.extend(d.prototype,{init:function(){var b=this;if(a(this.element).click(function(){return b.showPasteDialog(),!1}),b.settings.openOnPageLoad){var d=this.element;a(c).ready(function(){a(d).is(":visible")&&b.showPasteDialog()})}},showPasteDialog:function(c,d){var e=this,f=a('<div><div></div><span style="color: red;"></span><div style="margin-bottom: -50px; height: 50px; width: 100%; text-align: center; font-size: 2em; opacity: 0.3;"></div><iframe style="width: 100%"></iframe><div style="text-align: center;"><span></span><br/><input type="button" name="ok" value=""/><input type="button" name="cancel" value=""/></div></div>');f.dialog({title:e.settings.pasteHeader,modal:!0,minWidth:Math.max(600,Math.round(.7*a(b).width())),close:function(){e.settings.cancel()},open:function(){e.fixOverlayZindex(f)}}),f.find("div ~ span ~ div:first").text(e.settings.pasteLabel),f.find("div:last > span").text(e.settings.pasteHint);var g,h=f.find("iframe")[0];h.contentDocument?g=h.contentDocument:h.contentWindow?g=h.contentWindow.document:h.document&&(g=h.document),g.write('<body style="margin: 0; padding: 0;" CONTENTEDITABLE>'),null!=c&&(g.body.innerHTML=c,f.find("span").after('<a href="#" style="opacity: 0;">debug</a>'),f.find("a").click(function(){f.find("a").after('<br/>Debug information:<br/>Base64 of HTML:<br/><input type="text" onclick="this.select()" name="debug_base64" style="width: 100%" readonly="readonly"/><br/>HTML:<br/><textarea onclick="this.select()" name="debug_html" style="width: 100%; height: 150px;" readonly="readonly"></textarea>'),f.find('input[name="debug_base64"]').val(btoa(c)),f.find('textarea[name="debug_html"]').val(c)})),null!=d&&f.find("span").text(d),f.find('input[name="cancel"]').val(e.settings.pasteCancel).click(function(){f.dialog("close")}),f.find('input[name="ok"]').val(e.settings.pasteOk).click(function(){e.parseTable(g.body.innerHTML,f)});var i=g.body.innerHTML;g.body.focus(),g.execCommand("selectAll",!1,null);var j=!1;g.body.onkeydown=function(a){27!==a.keyCode||a.altKey||a.ctrlKey||a.shiftKey||f.is(":visible")&&(j=!0)},g.body.onkeyup=function(a){27!==a.keyCode||a.altKey||a.ctrlKey||a.shiftKey||!j?j=!1:(f.dialog("close"),j=!1),g.body.innerHTML!==i&&(i=g.body.innerHTML,e.parseTable(i,f))}},parseTable:function(c,d){var e=this;d.dialog("option","close",null),d.dialog("close");var f=a("<div><span></span></div>");f.dialog({title:e.settings.wait,modal:!0,minWidth:Math.max(600,Math.round(.7*a(b).width())),close:function(){e.showPasteDialog(c)},open:function(){e.fixOverlayZindex(f),setTimeout(function(){var b=e.parseHTMLTable(c),d=e.settings.postProcess(b),g=0;if(!1!==d){var h,i,j,k,l,m,n;for(h in d)if(0!==d[h].length){g++;var o=a("<div/>").appendTo(f),p=a('<table class="table table-bordered"/>').appendTo(o);a('<div style="text-align: center;"><input type="button" name="ok" value=""/><input type="button" name="cancel" value=""/></div>').appendTo(o),o.find('input[name="ok"]').val(e.settings.confirmOk),o.find('input[name="cancel"]').val(e.settings.confirmCancel),o.find('input[name="ok"]').attr("data-tableindex",h);var q=a("<tbody/>").appendTo(p),r=0;for(i in d[h])r=Math.max(r,d[h][i].length);for(i in d[h]){var s=a("<tr/>").appendTo(q);for(n=d[h][i].length;r>n;n++)d[h][i].push("");for(j in d[h][i]){var t=a("<td/>").appendTo(s);m=d[h][i][j],"undefined"==typeof m&&(m=""),"string"!=typeof m&&(m=""+m),d[h][i][j]=m,l=m.split("\n");for(k in l)a("<p/>").appendTo(t).text(l[k])}}}f.find("span").text(1>=g?e.settings.confirmLabelSingle:e.settings.confirmLabelMultiple),f.find("span").after('<a href="#" style="opacity: 0">debug</a>'),f.find("a").click(function(){return f.find("span").after('<br/>Debug information:<br/>Base64 of HTML:<br/><input type="text" onclick="this.select()" name="debug_base64" style="width: 100%" readonly="readonly"/><br/>HTML:<br/><textarea onclick="this.select()" name="debug_html" style="width: 100%; height: 150px;" readonly="readonly"></textarea><br/>Parsed JSON:<br/><textarea onclick="this.select()" name="debug_parsedjson" style="width: 100%; height: 150px;" readonly="readonly"></textarea><br/>Post processed JSON:<br/><textarea onclick="this.select()" name="debug_ppjson" style="width: 100%; height: 150px;" readonly="readonly"></textarea><br/>Cleaned (final) JSON:<br/><textarea onclick="this.select()" name="debug_cleanedjson" style="width: 100%; height: 150px;" readonly="readonly"></textarea>'),f.find('input[name="debug_base64"]').val(btoa(c)),f.find('textarea[name="debug_html"]').val(c),f.find('textarea[name="debug_parsedjson"]').val(JSON.stringify(b,null,"  ")),f.find('textarea[name="debug_ppjson"]').val(JSON.stringify(b,null,"  ")),f.find('textarea[name="debug_cleanedjson"]').val(JSON.stringify(b,null,"  ")),!1}),f.dialog("option","title",1>=g?e.settings.confirmHeaderSingle:e.settings.confirmHeaderMultiple),f.find('input[name="ok"]').click(function(){f.dialog("option","close",null),f.dialog("close"),e.settings.success(d[this.getAttribute("data-tableindex")])}),f.find('input[name="cancel"]').click(function(){f.dialog("close")}),f.find('input[name="ok"]').each(function(a,b){return b.scrollIntoView(),!1})}0===g&&(f.dialog("option","close",null),f.dialog("close"),e.showPasteDialog(c,e.settings.pasteError))},0)}})},parseHTMLTable:function(a){var b,c,d,e=[],f=[],g=[],h=[],i=[],j=[],k=!1;if(!/<table[^>]*>([\s\S]*)<\/table>/gim.test(a)){if(/(<br\/?>|<div>)/gim.test(a)){var l;a=a.replace(/<span[^>]*>/gim,"").replace(/<\/span>/gim,""),l=/(<br\/?>)/gim.test(a)?a.split(/<br\/?>/):a.replace(/<div>/gim,"").split(/<\/div\/?>/);var m,n,o,p,q;for(m=0;m<l.length;m++){for(n=l[m].replace(/[\n\r]/,""),n=n.replace(/(&nbsp;| )+/g,"	"),p=n.split(/[\t]/),j=[],o=0;o<p.length;o++)q=p[o],q.length>0&&j.push(q);j.length>0&&i.push(j)}return i.length>0?[i]:!1}return!1}for(e=a.split(/<\/table>/i),b=0;b<e.length;b++){if(i=[],e[b]=e[b].replace(/[\n\r]+/g,""),e[b]=e[b].replace(/^.*[<]table[^>]*[>]/gim,""),e[b]=e[b].replace(/[<]\/table[>].*$/gim,""),f=[],/<tr[^>]*>([\s\S]*)<\/tr>/gim.test(e[b]))for(f=e[b].split(/<\/tr>/i),c=0;c<f.length;c++){if(j=[],k=!1,g=[],f[c]=f[c].replace(/<tbody[^>]*>/gim,""),f[c]=f[c].replace(/<\/tbody>/gim,""),f[c]=f[c].replace(/<tr[^>]*>/gim,""),f[c]=f[c].replace(/<\/tr>/gim,""),/<td[^>]*>([\s\S]*)<\/td>/gim.test(f[c]))for(g=f[c].split(/<\/td>/i),d=0;d<g.length;d++)g[d]=g[d].replace(/<\?xml[^>]*[>]/gi,"").replace(/<\/?st1[:][^>]+[>]/g,"").replace(/<td[^>]*>\s*/gim,"").replace(/\s+$/gim,"").replace(/<\/td>/gim,"").replace(/line<\?[^\/>]*\/>/gim,"").replace(/<p[^>]*>/gim,"\n").replace(/<\/p>/gim,"").replace(/<span[^>]*>/gim,"").replace(/<\/span>/gim,"").replace(/<o[^>]*>/gim,"").replace(/<\/o[^>]*>/gim,"").replace(/&nbsp[;]/g," ").replace(/<br\/?>/g,"\n").replace(/[\r]/g,"").replace(/^\n+/,"").replace(/\n+$/,"").replace(/\n[\n \t]*\n/g,"\n").replace(/\n\s+/g,"\n").replace(/[ \t]+/g," ").replace(/^\s+/g,"").replace(/<colgroup[ >](.*<\/colgroup>)?[ \r\n]*/g,"").replace(/<col(([ ]?[>])|([ ][^>]+[>]))[ \r\n]*/g,"").replace(/<font[^>]*>/g,"").replace(/<\/font>/g,"").replace(/<b( [^>]+)?>/g,"").replace(/<\/b>/g,"").replace(/<strong>/g,"").replace(/<\/strong>/g,"").replace(/&amp;/g,"&").replace(/^\s+/g,"").replace(/\s+$/g,""),this.settings.allowNewLines||(g[d]=g[d].replace(/[\n]+/g," ")),j.push(g[d]),g[d].length>0&&(k=d);if(k!==!1){for(;j.length>k+1;)j.pop();i.push(j)}}i.length>0&&h.push(i)}return h},fixOverlayZindex:function(b){var c,d=100;a(this.element).parents().each(function(b,e){c=parseInt(a(e).css("z-index")),c>d&&(d=c)}),a(".ui-widget-overlay").css("z-index",d+1),b.parent().css("z-index",d+2)}}),a.fn[e]=function(b){return this.each(function(){a.data(this,"plugin_"+e)||a.data(this,"plugin_"+e,new d(this,b))})}}(jQuery,window,document);